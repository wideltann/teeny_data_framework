#!/bin/bash
# Pre-push hook: Format code and run ALL tests before pushing to remote

set -e  # Exit immediately on any error

echo "üé® Formatting code with ruff..."
uv run ruff format .

# If ruff made changes, stage them and amend the commit
if ! git diff --quiet; then
    echo "üìù Staging formatting changes..."
    git add -u
    git commit --amend --no-edit
    echo ""
fi

echo "üß™ Running tests before push..."
echo ""

# Check if Podman is running (required for container tests)
if ! podman info > /dev/null 2>&1; then
    echo "‚ùå Podman is not running!"
    echo "Container tests require Podman. Start it with: podman machine start"
    echo ""
    echo "Push aborted."
    exit 1
fi

# Run ALL tests (not just a subset)
export DOCKER_HOST=unix:///var/run/docker.sock
uv run pytest tests/ -v

echo ""
echo "‚úÖ All tests passed! Proceeding with push..."
